<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <title>GlukoMeter IQC</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css">
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <link rel="apple-touch-icon" href="Glucometer.png">
    <link rel="icon" type="image/png" href="Glucometer.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #2ecc71; --error: #e74c3c; --text: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: background-color 0.5s ease;}
        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        h2 { margin-top: 0; color: var(--primary); font-size: 1.2rem; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 2px solid #333; background: #252525; color: white; box-sizing: border-box; font-size: 16px; }
        .row { display: flex; gap: 10px; }
        button { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn-save { background: var(--primary); color: white; margin-top: 10px; }
        .btn-ref { background: #3498db; color: white; }
        .status { text-align: center; margin-top: 10px; font-size: 0.9rem; }
        .low { border-color: #3498db !important; }
        .high { border-color: var(--error) !important; }
        .normal { border-color: var(--primary) !important; }

        /* Kamera Butonu ve VizÃ¶r Stili */
        .seri-container { position: relative; display: flex; align-items: center; }
        .btn-scan { position: absolute; right: 8px; background: #444; color: white; width: 40px; height: 40px; padding: 0; display: flex; justify-content: center; align-items: center; border-radius: 6px; }
        #reader { 
            width: 100%; 
            border-radius: 10px; 
            overflow: hidden; 
            background: #000;
            position: relative; 
            border: 2px solid #444; 
        }
        #reader::after {
            content: "";
            position: absolute;
            top: 50%; 
            left: 50%;
            width: 70%; /* GeniÅŸlik */
            height: 40%; /* YÃ¼kseklik */
            border: 2px solid var(--primary);
            transform: translate(-50%, -50%);
            border-radius: 12px;
            /* Ã‡erÃ§evenin dÄ±ÅŸÄ±nÄ± hafifÃ§e karartarak odaklanmayÄ± artÄ±rÄ±r */
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); 
            pointer-events: none; /* TÄ±klamalarÄ± engellemez */
            z-index: 10;
        }
    </style>
</head>
<body>

    <div id="setup-screen" class="card">
        <h2>Referans AyarlarÄ±</h2>
        <p style="font-size: 0.8rem; color: #aaa;">LÃ¼tfen, kabul edilebilir aralÄ±klarÄ± giriniz.</p>
        <div class="row">
            <input type="number" id="ref_s1m" placeholder="L1 Min">
            <input type="number" id="ref_s1x" placeholder="L1 Max">
        </div>
        <div class="row">
            <input type="number" id="ref_s2m" placeholder="L2 Min">
            <input type="number" id="ref_s2x" placeholder="L2 Max">
        </div>
        <button class="btn-ref" onclick="saveRefs()">AyarlarÄ± Onayla</button><br><br>
        <button class="btn-ref" onclick="fetchLastRefs(event)" style="background:#f39c12; margin-bottom:10px;">En Son ReferanslarÄ± Getir</button>
    </div>

    <div id="main-screen" class="card" style="display:none;">
        <h2>Veri GiriÅŸi</h2>

        <div id="counter-box" style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 10px; font-weight: bold;">
            <span style="color: #f39c12;" id="pending-status"></span>
            <span style="color: var(--primary);">BugÃ¼n Toplam: <span id="daily-count">0</span> KayÄ±t YaptÄ±nÄ±z</span>
        </div>

        <div id="reader-wrapper" style="display:none; margin-bottom: 15px;">
            <div id="reader"></div>
            <button onclick="stopScan()" style="background: var(--error); margin-top: 10px; padding: 10px;">KamerayÄ± Kapat</button>
        </div>

        <div class="seri-container">
            <input type="text" id="seri" placeholder="Cihaz Seri No">
            <button class="btn-scan" onclick="beepAudio.play().then(() => {beepAudio.pause(); beepAudio.currentTime = 0;}); startScan()">ğŸ“·</button>
        </div>
        

        <input type="number" 
            id="s1" 
            placeholder="Seviye 1 Sonucu" 
            oninput="checkValue(this, 's1')" 
            onkeydown="blockNonNumbers(event)" 
            min="0" 
            inputmode="numeric">
        <div id="s1-msg" style="font-size: 0.8rem; margin-bottom: 10px; transition: 0.3s;"></div>

        <input type="number" 
            id="s2" 
            placeholder="Seviye 2 Sonucu" 
            oninput="checkValue(this, 's2')" 
            onkeydown="blockNonNumbers(event)" 
            min="0" 
            inputmode="numeric">
        <div id="s2-msg" style="font-size: 0.8rem; margin-bottom: 10px; transition: 0.3s;"></div>
        
        <button class="btn-save" onclick="sendData()">SONUÃ‡LARI KAYDET</button>
        <div id="status" class="status"></div>
        <button onclick="backToSetup()" style="background: none; color: #888; border: 1px solid #444; margin-top: 15px; padding: 8px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 0.8rem;">
            âš™ï¸ Referans AyarlarÄ±nÄ± DÃ¼zenle
        </button>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby5e7MeyiMfWHQtwnZQThzrNApVNg16M2ypeVL4ZeH_u1_7k5ofEDz2w5q2Mkp8SiWI1A/exec";
        let refs = {};
        const seriInput = document.getElementById('seri');
        const s1Input = document.getElementById('s1');
        const s2Input = document.getElementById('s2');
        let html5QrCode;
        const beepAudio = new Audio('./beep.ogg');

        window.addEventListener('load', () => {
            syncOfflineData();
            const savedRefs = localStorage.getItem('gluco_refs');
            if (savedRefs) {
                refs = JSON.parse(savedRefs);
                document.getElementById('ref_s1m').value = refs.s1m;
                document.getElementById('ref_s1x').value = refs.s1x;
                document.getElementById('ref_s2m').value = refs.s2m;
                document.getElementById('ref_s2x').value = refs.s2x;
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('main-screen').style.display = 'block';
            }
            displayCounter();
            updatePendingStatus();
        });

        function saveRefs() {
            refs = {
                s1m: parseFloat(document.getElementById('ref_s1m').value),
                s1x: parseFloat(document.getElementById('ref_s1x').value),
                s2m: parseFloat(document.getElementById('ref_s2m').value),
                s2x: parseFloat(document.getElementById('ref_s2x').value)
            };
            if (Object.values(refs).some(isNaN)) {
                Swal.fire({ icon: 'warning', title: 'Eksik Bilgi', text: 'LÃ¼tfen tÃ¼m referans deÄŸerlerini doldurun!', confirmButtonColor: '#3498db' });
                return;
            }
            localStorage.setItem('gluco_refs', JSON.stringify(refs));
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'block';

            Swal.fire({ 
                icon: 'success', 
                title: 'HazÄ±r!', 
                text: 'Referanslar kaydedildi.', 
                timer: 2000, 
                showConfirmButton: false,
                didClose: () => {
                    seriInput.focus();
                    setTimeout(() => seriInput.focus(), 50);
                }
            });
        }

        function updateCounter(reset = false) {
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem('counter_date');
            let count = parseInt(localStorage.getItem('daily_count') || '0');
            if (lastDate !== today || reset) {
                count = 0;
                localStorage.setItem('counter_date', today);
            } else {
                count++;
            }
            localStorage.setItem('daily_count', count);
            document.getElementById('daily-count').innerText = count;
        }

        function displayCounter() {
            const today = new Date().toDateString();
            if (localStorage.getItem('counter_date') !== today) {
                localStorage.setItem('daily_count', '0');
                localStorage.setItem('counter_date', today);
            }
            document.getElementById('daily-count').innerText = localStorage.getItem('daily_count') || '0';
        }

        function updatePendingStatus() {
            const queue = JSON.parse(localStorage.getItem('pending_sync') || '[]');
            const statusEl = document.getElementById('pending-status');
            statusEl.innerText = queue.length > 0 ? `â³ ${queue.length} Bekleyen` : "";
        }

        function checkValue(el, type) {
            const val = parseFloat(el.value);
            const msgEl = document.getElementById(type + '-msg');
            const min = type === 's1' ? refs.s1m : refs.s2m;
            const max = type === 's1' ? refs.s1x : refs.s2x;
            
            el.className = ""; 
            msgEl.innerText = "";
            
            if (isNaN(val)) {
                updateScreenColor(); // DeÄŸer silinirse rengi kontrol et
                return;
            }

            if (val < min) {
                el.classList.add('low'); 
                msgEl.innerText = "âš ï¸ DÃ¼ÅŸÃ¼k (Min: " + min + ")"; 
                msgEl.style.color = "#3498db";
            } else if (val > max) {
                el.classList.add('high'); 
                msgEl.innerText = "âš ï¸ YÃ¼ksek (Max: " + max + ")"; 
                msgEl.style.color = "#e74c3c";
            } else {
                el.classList.add('normal'); 
                msgEl.innerText = "âœ… Uygun"; 
                msgEl.style.color = "#2ecc71";

                if (type === 's1') {
                    setTimeout(() => {
                        s2Input.focus();
                    }, 400); // 400ms gecikme kullanÄ±cÄ±nÄ±n yazdÄ±ÄŸÄ±nÄ± gÃ¶rmesi iÃ§in idealdir
                }
                
            }

            updateScreenColor(); // Her deÄŸiÅŸimde ana ekran rengini gÃ¼ncelle
        }

        function updateScreenColor() {
            
            // Hata durumlarÄ±nÄ± kontrol et
            const hasHigh = s1Input.classList.contains('high') || s2Input.classList.contains('high');
            const hasLow = s1Input.classList.contains('low') || s2Input.classList.contains('low');

            if (hasHigh) {
                document.body.style.backgroundColor = "#4c1c1c"; // Ã‡ok koyu kÄ±rmÄ±zÄ±/kahve (UyarÄ±)
            } else if (hasLow) {
                document.body.style.backgroundColor = "#1a2a3a"; // Ã‡ok koyu mavi (DÃ¼ÅŸÃ¼k)
            } else {
                document.body.style.backgroundColor = "var(--bg)"; // Normal koyu gri
            }
        }

        function blockNonNumbers(e) {
            // Ä°zin verilen tuÅŸlar: Backspace, Delete, Tab, Escape, Enter ve Ok tuÅŸlarÄ±
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight'];
            
            // EÄŸer basÄ±lan tuÅŸ listede yoksa ve bir rakam deÄŸilse iÅŸlemi engelle
            if (!allowedKeys.includes(e.key) && (e.key < '0' || e.key > '9')) {
                e.preventDefault();
            }
        }

        async function sendData() {
            const v1 = parseFloat(s1Input.value);
            const v2 = parseFloat(s2Input.value);

            const data = { 
                seri: seriInput.value, 
                s1: s1Input.value, 
                s2: s2Input.value, 
                ...refs, 
                timestamp: new Date().toLocaleString('tr-TR') 
            };

            // 1. Temel GiriÅŸ Kontrolleri
            if (!data.seri || isNaN(v1) || isNaN(v2)) {
                Swal.fire({ icon: 'error', title: 'Eksik Veri', text: 'TÃ¼m alanlarÄ± doldurun.' });
                return;
            }

            // 2. Referans AralÄ±ÄŸÄ± KontrolÃ¼ ve Onay MekanizmasÄ±
            if (v1 < refs.s1m || v1 > refs.s1x || v2 < refs.s2m || v2 > refs.s2x) {
                const result = await Swal.fire({ 
                    title: 'Emin misiniz?',
                    text: 'GirdiÄŸiniz sonuÃ§lar referans aralÄ±ÄŸÄ± dÄ±ÅŸÄ±ndadÄ±r. Yine de kaydetmek istiyor musunuz?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#e74c3c',
                    cancelButtonColor: '#3498db',
                    confirmButtonText: 'Evet, Kaydet',
                    cancelButtonText: 'HayÄ±r, DÃ¼zenle',
                    background: '#1e1e1e',
                    color: '#fff'
                });
                if (!result.isConfirmed) return;
            }

            // 3. Ä°nternet Yoksa Direkt Ã‡evrimdÄ±ÅŸÄ± KuyruÄŸa At
            if (!navigator.onLine) { 
                saveToOfflineQueue(data); 
                return; 
            }

            // 4. Zaman AÅŸÄ±mÄ± KontrolÃ¼ (AbortController)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 Saniye SÄ±nÄ±rÄ±

            Swal.fire({ 
                title: 'Kaydediliyor...', 
                text: 'LÃ¼tfen bekleyin',
                didOpen: () => { Swal.showLoading() },
                allowOutsideClick: false
            });

            try {
                // Fetch isteÄŸini baÅŸlat
                const response = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(data),
                    signal: controller.signal // Sinyal ekleniyor
                });

                clearTimeout(timeoutId); // Ä°stek baÅŸarÄ±lÄ± olduysa zamanlayÄ±cÄ±yÄ± iptal et

                // Formu temizle ve sayaÃ§larÄ± gÃ¼ncelle
                clearForm();
                updateCounter();
                updatePendingStatus();

                Swal.fire({ 
                    icon: 'success', 
                    title: 'Harika', 
                    text: 'Veriler baÅŸarÄ±yla ArÅŸive aktarÄ±ldÄ±.', 
                    timer: 1000,
                    showConfirmButton: false,
                    background: '#1e1e1e',
                    color: '#fff',
                    didClose: () => {
                        seriInput.focus();
                        setTimeout(() => seriInput.focus(), 50);
                    }
                });

            } catch (e) {
                // Hata tÃ¼rÃ¼ 'AbortError' ise (zaman aÅŸÄ±mÄ±) veya aÄŸ hatasÄ±ysa kuyruÄŸa at
                clearTimeout(timeoutId);
                console.warn("BaÄŸlantÄ± yavaÅŸ veya hata oluÅŸtu, Ã§evrimdÄ±ÅŸÄ± moda geÃ§iliyor:", e.name);
                saveToOfflineQueue(data);
            }
        }

        function clearForm() {
            ['seri', 's1', 's2'].forEach(id => document.getElementById(id).value = "");
            ['s1', 's2'].forEach(id => { document.getElementById(id).className = ""; document.getElementById(id+'-msg').innerText = ""; });

            updateScreenColor(); // Rengi sÄ±fÄ±rla
        }

        function saveToOfflineQueue(data) {
            let queue = JSON.parse(localStorage.getItem('pending_sync') || '[]');
            queue.push(data);
            localStorage.setItem('pending_sync', JSON.stringify(queue));
            Swal.fire({ 
                icon: 'info', 
                title: 'Ã‡evrimdÄ±ÅŸÄ± Kaydedildi', 
                text: 'Ä°nternetiniz ÅŸu an kapalÄ±. Veri cihaza kaydedildi, internet gelince otomatik gÃ¶nderilecek.',
                timer: 3000,
                didClose: () => {
                    seriInput.focus();
                    setTimeout(() => seriInput.focus(), 50);
                }
            });
            updateCounter();
            updatePendingStatus();
            clearForm();
            seriInput.focus();
        }

        async function syncOfflineData() {
            let queue = JSON.parse(localStorage.getItem('pending_sync') || '[]');
            if (queue.length === 0) return;
            for (let item of queue) {
                try { await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(item) }); } 
                catch (e) { return; }
            }
            localStorage.removeItem('pending_sync');
            updatePendingStatus();
            Swal.fire({ icon: 'success', title: 'EÅŸitleme Tamam', toast: true, position: 'top-end', timer: 3000 });
        }

        // --- KAMERA FONKSÄ°YONLARI ---
        async function startScan() {
            const wrapper = document.getElementById('reader-wrapper');
            wrapper.style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            try {
                await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (text) => {

                    beepAudio.play().catch(e => console.log("Ses Ã§alma engellendi:", e));  // QR Kod okuma sesi ekliyoruz.
                    
                    const sonOnAlti = text.trim().slice(-16);  // Metnin son 16 karakterini alÄ±yoruz. BoÅŸluklarÄ± temizleyerek.              
                    
                    seriInput.value = sonOnAlti;  // Input alanÄ±na sadece bu 16 haneyi yazdÄ±rÄ±yoruz

                    if (navigator.vibrate) navigator.vibrate(50);  // TitreÅŸim desteÄŸi


                    stopScan();
                    // KÃ¼Ã§Ã¼k bir gecikme ile odaklanma (mobil tarayÄ±cÄ± uyumu iÃ§in)
                    setTimeout(() => {
                        s1Input.focus();
                        s1Input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }, () => {});
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Kamera HatasÄ±', text: 'Ä°zin verilmedi veya HTTPS deÄŸil.' });
                wrapper.style.display = 'none';
            }
        }

        function stopScan() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => { document.getElementById('reader-wrapper').style.display = 'none'; });
            }
        }

        function backToSetup() {
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'block';
        }

        async function fetchLastRefs(e) {
            const btn = e.currentTarget;
            btn.innerText = "YÃ¼kleniyor..."; btn.disabled = true;
            try {
                const res = await fetch(SCRIPT_URL);
                const d = await res.json();
                document.getElementById('ref_s1m').value = d.s1m || "";
                document.getElementById('ref_s1x').value = d.s1x || "";
                document.getElementById('ref_s2m').value = d.s2m || "";
                document.getElementById('ref_s2x').value = d.s2x || "";
                Swal.fire({ icon: 'success', title: 'GÃ¼ncellendi', timer: 1000 });
            } catch (e) { Swal.fire({ icon: 'error', title: 'Hata' }); }
            finally { btn.innerText = "En Son ReferanslarÄ± Getir"; btn.disabled = false; }
        }

        // YapÄ±ÅŸtÄ±rma iÅŸlemini kontrol et (Sadece rakamsa izin ver)
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('paste', e => {
                const pasteData = e.clipboardData.getData('text');
                if (!/^\d+$/.test(pasteData)) {
                    e.preventDefault();
                }
            });
        });

        // Enter Navigasyonu
        seriInput.addEventListener('keypress', e => { if(e.key === 'Enter') s1Input.focus(); });
        s1Input.addEventListener('keypress', e => { if(e.key === 'Enter') s2Input.focus(); });
        s2Input.addEventListener('keypress', e => { if(e.key === 'Enter') sendData(); });

        window.addEventListener('online', syncOfflineData);
    </script>
</body>
</html>

