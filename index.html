
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <title>GlukoMeter IQC</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css">
    <link rel="apple-touch-icon" href="Glucometer.png">
    <link rel="icon" type="image/png" href="Glucometer.png"><link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #2ecc71; --error: #e74c3c; --text: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        h2 { margin-top: 0; color: var(--primary); font-size: 1.2rem; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 2px solid #333; background: #252525; color: white; box-sizing: border-box; font-size: 16px; }
        .row { display: flex; gap: 10px; }
        button { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn-save { background: var(--primary); color: white; margin-top: 10px; }
        .btn-ref { background: #3498db; color: white; }
        .status { text-align: center; margin-top: 10px; font-size: 0.9rem; }
        .low { border-color: #3498db !important; }
        .high { border-color: var(--error) !important; }
        .normal { border-color: var(--primary) !important; }
    </style>
</head>
<body>

    <div id="setup-screen" class="card">
        <h2>Referans Ayarları</h2>
        <p style="font-size: 0.8rem; color: #aaa;">Lütfen, kabul edilebilir aralıkları giriniz.</p>
        <div class="row">
            <input type="number" id="ref_s1m" placeholder="L1 Min">
            <input type="number" id="ref_s1x" placeholder="L1 Max">
        </div>
        <div class="row">
            <input type="number" id="ref_s2m" placeholder="L2 Min">
            <input type="number" id="ref_s2x" placeholder="L2 Max">
        </div>
        <button class="btn-ref" onclick="saveRefs()">Ayarları Onayla</button><br><br>
        <button class="btn-ref" onclick="fetchLastRefs(event)" style="background:#f39c12; margin-bottom:10px;">En Son Referansları Getir</button>
    </div>

    <div id="main-screen" class="card" style="display:none;">
        <h2>Veri Girişi</h2>

        <div id="counter-box" style="text-align: right; font-size: 0.8rem; color: var(--primary); margin-bottom: 10px; font-weight: bold;">
            Bugün Toplam: <span id="daily-count">0</span> Kayıt
        </div>

        <input type="text" id="seri" placeholder="Cihaz Seri No">
        
        <input type="number" id="s1" placeholder="Seviye 1 Sonucu" oninput="checkValue(this, 's1')">
        <div id="s1-msg" style="font-size: 0.8rem; margin-bottom: 10px; transition: 0.3s;"></div>
    
        <input type="number" id="s2" placeholder="Seviye 2 Sonucu" oninput="checkValue(this, 's2')">
        <div id="s2-msg" style="font-size: 0.8rem; margin-bottom: 10px; transition: 0.3s;"></div>
        
        <button class="btn-save" onclick="sendData()">SONUÇLARI KAYDET</button>
        <div id="status" class="status"></div>
        <button onclick="backToSetup()" style="background: none; color: #888; border: 1px solid #444; margin-top: 15px; padding: 8px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 0.8rem;">
            ⚙️ Referans Ayarlarını Düzenle
        </button>
    </div>

    <script>

        // Sayfa her yüklendiğinde çalışacak olan kod
        window.addEventListener('load', () => {
            // 1. Bekleyen verileri senkronize et
            syncOfflineData();
        
            // 2. Referansları yükle
            const savedRefs = localStorage.getItem('gluco_refs');
            if (savedRefs) {
                refs = JSON.parse(savedRefs);
                document.getElementById('ref_s1m').value = refs.s1m;
                document.getElementById('ref_s1x').value = refs.s1x;
                document.getElementById('ref_s2m').value = refs.s2m;
                document.getElementById('ref_s2x').value = refs.s2x;
        
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('main-screen').style.display = 'block';
                console.log("Kayıtlı referanslar yüklendi.");
            }

            displayCounter();

        });
        
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby5e7MeyiMfWHQtwnZQThzrNApVNg16M2ypeVL4ZeH_u1_7k5ofEDz2w5q2Mkp8SiWI1A/exec";
        let refs = {};

        function saveRefs() {
            refs = {
                s1m: parseFloat(document.getElementById('ref_s1m').value),
                s1x: parseFloat(document.getElementById('ref_s1x').value),
                s2m: parseFloat(document.getElementById('ref_s2m').value),
                s2x: parseFloat(document.getElementById('ref_s2x').value)
            };
            
            if (Object.values(refs).some(isNaN)) {
                Swal.fire({ icon: 'warning', title: 'Eksik Bilgi', text: 'Lütfen tüm referans değerlerini doldurun!', confirmButtonColor: '#3498db' });
                return;
            }

            localStorage.setItem('gluco_refs', JSON.stringify(refs));

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'block';
            
            Swal.fire({ icon: 'success', title: 'Hazır!', text: 'Referanslar kaydedildi, veri girişine başlayabilirsiniz.', timer: 2000, showConfirmButton: false });
        }


        // Sayacı güncelleyen ve ekrana yazan fonksiyon
        function updateCounter(reset = false) {
            const today = new Date().toDateString(); // Bugünün tarihi (Örn: "Sat May 20 2023")
            const lastDate = localStorage.getItem('counter_date');
            let count = parseInt(localStorage.getItem('daily_count') || '0');

            // Eğer tarih değişmişse sayacı sıfırla
            if (lastDate !== today || reset) {
                count = 0;
                localStorage.setItem('counter_date', today);
            } else {
                count++;
            }

            localStorage.setItem('daily_count', count);
            document.getElementById('daily-count').innerText = count;
        }

        // Sadece ekranda göstermek için (sayıyı artırmadan)
        function displayCounter() {
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem('counter_date');
            
            if (lastDate !== today) {
                localStorage.setItem('daily_count', '0');
                localStorage.setItem('counter_date', today);
            }
            
            document.getElementById('daily-count').innerText = localStorage.getItem('daily_count') || '0';
        }

        function checkValue(el, type) {
            const val = parseFloat(el.value);
            const msgEl = document.getElementById(type + '-msg'); // s1-msg veya s2-msg
            
            // Referans değerlerini al
            const min = type === 's1' ? refs.s1m : refs.s2m;
            const max = type === 's1' ? refs.s1x : refs.s2x;
            
            // Sıfırlama
            el.className = "";
            msgEl.innerText = "";
            
            if (isNaN(val)) return;
        
            if (val < min) {
                el.classList.add('low');
                msgEl.innerText = "⚠️ Düşük Değer (Min: " + min + ")";
                msgEl.style.color = "#3498db";
            } else if (val > max) {
                el.classList.add('high');
                msgEl.innerText = "⚠️ Yüksek Değer (Max: " + max + ")";
                msgEl.style.color = "#e74c3c";
            } else {
                el.classList.add('normal');
                msgEl.innerText = "✅ Değer Uygun";
                msgEl.style.color = "#2ecc71";
            }
        }

        // Ayarlar ekranına geri dönme fonksiyonu
        function backToSetup() {
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'block';
                
            // Opsiyonel: Girişleri temizle
            document.getElementById('s1').value = "";
            document.getElementById('s2').value = "";
            document.getElementById('s1-msg').innerText = "";
            document.getElementById('s2-msg').innerText = "";
          }

        // İnternet yoksa veriyi tarayıcı hafızasına (kuyruğa) ekleyen fonksiyon
        function saveToOfflineQueue(data) {
            // Mevcut bekleyen listesini al, yoksa boş liste oluştur
            let queue = JSON.parse(localStorage.getItem('pending_sync') || '[]');
            
            // Yeni veriyi listeye ekle
            queue.push(data);
            
            // Güncel listeyi hafızaya geri yaz
            localStorage.setItem('pending_sync', JSON.stringify(queue));
            
            Swal.fire({
                icon: 'info',
                title: 'Bağlantı Yok',
                text: 'İnternetiniz şu an kapalı. Veri cihaza kaydedildi, internet gelince otomatik gönderilecek.',
                timer: 3000
            });

            updateCounter();
            
            // Formu temizle (Kullanıcı yeni cihaz girebilsin)
            document.getElementById('seri').value = "";
            document.getElementById('s1').value = "";
            document.getElementById('s2').value = "";
            document.getElementById('s1').className = "";
            document.getElementById('s2').className = "";
            document.getElementById('s1-msg').innerText = "";
            document.getElementById('s2-msg').innerText = "";
            document.getElementById('seri').focus();
        }

        async function sendData() {
            const seriInput = document.getElementById('seri');
            const s1Input = document.getElementById('s1');
            const s2Input = document.getElementById('s2');

            // Sayısal değerleri kontrol ve onay için değişkenlere atıyoruz
            const v1 = parseFloat(s1Input.value);
            const v2 = parseFloat(s2Input.value);

            // Google Sheets'e gidecek veri paketi
            const data = {
                seri: seriInput.value,
                s1: s1Input.value,
                s2: s2Input.value,
                ...refs,
                timestamp: new Date().toLocaleString('tr-TR')
            };

            // 1. Temel Boşluk Kontrolü
            if (!data.seri || isNaN(v1) || isNaN(v2)) {
                Swal.fire({ 
                    icon: 'error', 
                    title: 'Eksik Veri', 
                    text: 'Lütfen cihaz seri numarasını ve her iki ölçüm sonucunu da giriniz.',
                    background: '#1e1e1e',
                    color: '#fff'
                });
                return;
            }

            // 2. Kritik Aralık Kontrolü (Onay Mekanizması)
            const isS1Out = v1 < refs.s1m || v1 > refs.s1x;
            const isS2Out = v2 < refs.s2m || v2 > refs.s2x;

            if (isS1Out || isS2Out) {
                const result = await Swal.fire({
                    title: 'Emin misiniz?',
                    text: 'Girdiğiniz sonuçlar referans aralığı dışındadır. Yine de kaydetmek istiyor musunuz?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#e74c3c', // Kırmızı (Hata/Onay)
                    cancelButtonColor: '#3498db', // Mavi (Düzenle)
                    confirmButtonText: 'Evet, Kaydet',
                    cancelButtonText: 'Hayır, Düzenle',
                    background: '#1e1e1e',
                    color: '#fff'
                });

                // Kullanıcı "Hayır" derse işlemi durdur
                if (!result.isConfirmed) {
                    return; 
                }
            }

            // 3. Bağlantı Kontrolü (Offline Mode)
            if (!navigator.onLine) {
                saveToOfflineQueue(data);
                return;
            }

            // 4. Gönderim İşlemi (Online Mode)
            Swal.fire({ 
                title: 'Kaydediliyor...', 
                allowOutsideClick: false, 
                didOpen: () => { Swal.showLoading() } 
            });

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(data)
                });
                
                // Formu temizle
                seriInput.value = "";
                s1Input.value = "";
                s2Input.value = "";
                s1Input.className = "";
                s2Input.className = "";
                document.getElementById('s1-msg').innerText = "";
                document.getElementById('s2-msg').innerText = "";

                updateCounter();

                // Başarı Mesajı ve Odaklanma
                Swal.fire({ 
                    icon: 'success', 
                    title: 'Kaydedildi', 
                    text: 'Veriler başarıyla Google Sheets\'e aktarıldı.', 
                    timer: 1000,
                    showConfirmButton: false,
                    background: '#1e1e1e',
                    color: '#fff',
                    didClose: () => {
                        seriInput.focus();
                        setTimeout(() => seriInput.focus(), 50);
                    }
                });

            } catch (e) {
                // Beklenmedik bir ağ hatası olursa yerel kuyruğa at
                console.error("Gönderim hatası:", e);
                saveToOfflineQueue(data);
            }
        }

        async function fetchLastRefs(e) {
            const btn = e.currentTarget;
            const originalText = btn.innerText;
            
            btn.innerText = "Yükleniyor...";
            btn.disabled = true;

            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();

                document.getElementById('ref_s1m').value = data.s1m || "";
                document.getElementById('ref_s1x').value = data.s1x || "";
                document.getElementById('ref_s2m').value = data.s2m || "";
                document.getElementById('ref_s2x').value = data.s2x || "";
                
                Swal.fire({ icon: 'success', title: 'Veriler Getirildi', text: 'Son kullanılan referanslar yüklendi.', timer: 1500 });

            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Hata', text: 'Referanslar alınamadı! Apps Script bağlantısını kontrol edin.' });
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // Seri No yazıp Enter'a basınca S1'e geçer
        document.getElementById('seri').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') document.getElementById('s1').focus();
        });

        // S1 yazıp Enter'a basınca S2'ye geçer
        document.getElementById('s1').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') document.getElementById('s2').focus();
        });

        // S2 yazıp Enter'a basınca kaydet butonunu tetikler
        document.getElementById('s2').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendData();
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
              navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('PWA Hazır!', reg))
                .catch(err => console.log('Hata:', err));
            });
          }

        // Hafızada bekleyen verileri Google Sheets'e gönderen fonksiyon
        async function syncOfflineData() {
            let queue = JSON.parse(localStorage.getItem('pending_sync') || '[]');
            
            if (queue.length === 0) return; // Bekleyen veri yoksa işlem yapma
        
            console.log("İnternet geldi, " + queue.length + " kayıt gönderiliyor...");
            
            for (let i = 0; i < queue.length; i++) {
                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(queue[i])
                    });
                } catch (e) {
                    console.log("Gönderim başarısız, bir sonraki denemede tekrar yapılacak.");
                    return; // Hata alırsak döngüden çık (internet tekrar gitmiş olabilir)
                }
            }
        
            // Tüm liste başarıyla bittiyse hafızayı temizle
            localStorage.removeItem('pending_sync');
            
            Swal.fire({
                icon: 'success',
                title: 'Eşitleme Başarılı',
                text: 'Çevrimdışı kaydedilen veriler başarıyla aktarıldı.',
                toast: true,
                position: 'top-end',
                timer: 3000,
                showConfirmButton: false
            });
        }
        
        // Olay dinleyicileri: İnternet geldiğinde ve uygulama açıldığında çalışır
        window.addEventListener('online', syncOfflineData);
        

    </script>
</body>

</html>







